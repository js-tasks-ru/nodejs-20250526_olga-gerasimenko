# Задание: Реализация аутентификации (JWT + Google)

В этом задании вы реализуете логику аутентификации в вашем приложении с использованием двух стратегий: **JWT** (JSON
Web Token) и **Google OAuth**. Вам необходимо:

1. Настроить JWT-стратегию, проверяющую токен из заголовка запроса.
2. Настроить Google OAuth-стратегию, позволяющую пользователям авторизовываться через Google.
3. Защитить маршрут `/auth/profile` с помощью `JWT Guard`, чтобы доступ к профилю могли получить только авторизованные пользователи.

---

## Общая структура задания

1. **Настройка JWT-стратегии**
   - Создайте `AuthService` и используйте `passport-jwt` для генерации и проверки токенов.
   - Реализуйте эндпоинт, который принимает логин/пароль и возвращает пользователю JWT-токен.
2. **Настройка Google OAuth**
   - Создайте роуты `/auth/google` и `/auth/google/callback` для проведения аутентификации через Google (с использованием `passport-google-oauth20`).
   - После успешной аутентификации сохраняйте/генерируйте JWT-токен и передавайте его клиенту (например, в URL, cookie или локальном хранилище).
3. **Реализация защищённого маршрута `/auth/profile`**
   - Используйте `@UseGuards(JwtAuthGuard)` (или аналогичный Guard, созданный вами) для проверки валидности токена.
   - Если токен валиден, возвращайте профиль пользователя, если нет — возвращайте ошибку 401.

Для генерации JWT-токена, используйте секретный ключ - "killer-is-jim" (это очень важно, так как иначе автоматические
тесты не пройдут).

---

## Маршруты и примеры

Ниже приведён пример минимального набора маршрутов для решения задачи.

### 1. Авторизация через Google

#### Шаг 1. Редирект на Google

| Метод | Ссылка       | Описание                                                         | Параметры |
| ----- | ------------ | ---------------------------------------------------------------- | --------- |
| GET   | /auth/google | Перенаправляет пользователя на страницу авторизации Google OAuth | -         |

**Пример запроса**:

```http
GET http://localhost:3000/auth/google
```

**Результат**: Редирект на Google, где пользователь должен подтвердить доступ.

#### Шаг 2. Обработка колбэка

| Метод | Ссылка                | Описание                                                                                          | Параметры |
| ----- | --------------------- | ------------------------------------------------------------------------------------------------- | --------- |
| GET   | /auth/google/callback | Получает данные профиля от Google, выдает/генерирует JWT для пользователя и перенаправляет дальше | -         |

**Пример запроса**:

```http
GET http://localhost:3000/auth/google/callback
```

**Пример ожидаемой логики**:

- После успешного ответа от Google вы получаете профиль пользователя (email, имя и т.д.).
- Проверяете, есть ли такой пользователь в вашей базе. Если нет — создаёте.
- Генерируете JWT-токен и передаёте пользователю (способ передачи — на ваше усмотрение: в теле ответа, через редирект на фронтенд и т.д.).

---

### 2. Доступ к профилю (защищённый маршрут)

| Метод | Ссылка        | Описание                                             | Параметры                         |
| ----- | ------------- | ---------------------------------------------------- | --------------------------------- |
| GET   | /auth/profile | Возвращает профиль текущего пользователя (JWT-guard) | Требует заголовок `Authorization` |

**Пример запроса**:

```http
GET http://localhost:3000/auth/profile
Authorization: Bearer <ваш JWT-токен>
```

**Пример ответа** (если токен валиден и пользователь найден):

```json
{
  "id": 1,
  "email": "test@example.com",
  "displayName": "John Doe",
  "avatar": "https://avatar.example.com/john.png"
}
```

**Пример ответа** (если токен недействителен или не передан):

```json
{
  "statusCode": 401,
  "message": "Unauthorized"
}
```

---

## Основные шаги реализации

1. **Создание модуля аутентификации**:

   - `AuthModule`, где вы регистрируете стратегии (JWT, Google).
   - `AuthService`, где вы пишете логику генерации и проверки JWT.

2. **Создание стратегии JWT**:

   - Используйте `PassportStrategy` из `@nestjs/passport`.
   - Укажите `jwtFromRequest` (обычно извлечение из заголовка `Authorization`).
   - Укажите `secretOrKey` для проверки токена.

3. **Создание стратегии Google**:

   - Используйте `PassportStrategy` для `GoogleStrategy`.
   - Укажите `clientID`, `clientSecret` и `callbackURL`.
   - В колбэке получайте профиль пользователя, находите или создаёте его в базе данных, возвращаете объект пользователя дальше.

4. **Создание Guard'а**:

   - `JwtAuthGuard`, наследуется от `AuthGuard('jwt')`.
   - Обрабатывает проверку токена.

5. **Защита маршрута /auth/profile**:

   - В контроллере используйте декоратор `@UseGuards(JwtAuthGuard)`.
   - Если проверка прошла успешно, возвращайте данные профиля.

6. **Тестирование маршрутов**:
   - Убедитесь, что при вызове `/auth/profile` без токена или с неверным токеном получаете `401`.
   - Убедитесь, что при корректном токене получаете профиль пользователя.
